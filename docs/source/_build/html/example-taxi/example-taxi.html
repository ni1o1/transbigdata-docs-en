<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Taxi GPS data processing &mdash; TransBigData 0.3.0 documentation</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" /><link rel="shortcut icon" href="../_static/logo2.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Identifying arrival and departure information from Bus GPS data" href="../example-busgps/example-busgps.html" />
    <link rel="prev" title="Installation" href="../getting_started.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html"><img src="../_static/logo-wordmark-light.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.3.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p><span class="caption-text">安装</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Installation</a></li>
</ul>
<p><span class="caption-text">Example</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Taxi GPS data processing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id2">Data pre-processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id3">Data Gridding</a></li>
<li class="toctree-l2"><a class="reference internal" href="#od">Origin-destination(OD) Extraction and aggregate taxi trips</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id4">Aggregate OD into polygons</a></li>
<li class="toctree-l2"><a class="reference internal" href="#matplotlib">Matplotlib-based map drawing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id5">Extraction of taxi trajectpries</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id6">Trajectories visualization</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../example-busgps/example-busgps.html">Identifying arrival and departure information from Bus GPS data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../metromodel/metromodel.html">Modeling for subway network topology</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Example-pNEUMA/Example-pNEUMA.html">pNEUMA trajectory dataset processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../example-bikesharing/example-bikesharing.html">Community detection for bicycle-sharing demand</a></li>
</ul>
<p><span class="caption-text">General Methods</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quality.html">Data Quality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../preprocess.html">Data Preprocess</a></li>
<li class="toctree-l1"><a class="reference internal" href="../grids.html">Data Gridding</a></li>
<li class="toctree-l1"><a class="reference internal" href="../odprocess.html">Data Aggregating</a></li>
<li class="toctree-l1"><a class="reference internal" href="../visualization.html">Data Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getbusdata.html">Data Acquisition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../traj.html">Trajectory Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gisprocess.html">GIS Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plot_map.html">Load the basemap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CoordinatesConverter.html">Coordinates and Distances</a></li>
</ul>
<p><span class="caption-text">methods for specific data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../taxigps.html">Taxi GPS data processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bikedata.html">Bike-sharing data processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../busgps.html">Bus GPS data processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../metroline.html">Bus and subway network topology modeling</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">TransBigData</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Taxi GPS data processing</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/example-taxi/example-taxi.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>Taxi GPS data processing<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<div class="line-block">
<div class="line">这个案例的Jupyter notebook: <a class="reference external" href="https://github.com/ni1o1/transbigdata/blob/main/example/Example%201-Taxi%20GPS%20data%20processing.ipynb">点击这里</a>.</div>
<div class="line">可以点击 <a class="reference external" href="https://mybinder.org/v2/gh/ni1o1/transbigdata/d7d6fa33ff16440ba1698b10dd3cf3f76ff00abd?urlpath=lab%2Ftree%2Fexample%2FExample%201-Taxi%20GPS%20data%20processing.ipynb">这个链接</a> 在线编辑器中尝试</div>
<div class="line">The sample dataset and the Jupyter notebook of the usage example is in the github repository at the following link: <a class="reference external" href="https://github.com/ni1o1/transbigdata/tree/main/example">https://github.com/ni1o1/transbigdata/tree/main/example</a></div>
<div class="line">In this example, we will introduce how to use the TransBigData package to efficiently process Taxi GPS data.</div>
<div class="line">Firstly, import the TransBigData and read the data using pandas</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">transbigdata</span> <span class="k">as</span> <span class="nn">tbd</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="c1">#读取数据</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;TaxiData-Sample.csv&#39;</span><span class="p">,</span><span class="n">header</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;VehicleNum&#39;</span><span class="p">,</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span><span class="s1">&#39;Lng&#39;</span><span class="p">,</span><span class="s1">&#39;Lat&#39;</span><span class="p">,</span><span class="s1">&#39;OpenStatus&#39;</span><span class="p">,</span><span class="s1">&#39;Speed&#39;</span><span class="p">]</span>
<span class="n">data</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>VehicleNum</th>
      <th>Time</th>
      <th>Lng</th>
      <th>Lat</th>
      <th>OpenStatus</th>
      <th>Speed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>34745</td>
      <td>20:27:43</td>
      <td>113.806847</td>
      <td>22.623249</td>
      <td>1</td>
      <td>27</td>
    </tr>
    <tr>
      <th>1</th>
      <td>34745</td>
      <td>20:24:07</td>
      <td>113.809898</td>
      <td>22.627399</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>34745</td>
      <td>20:24:27</td>
      <td>113.809898</td>
      <td>22.627399</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>34745</td>
      <td>20:22:07</td>
      <td>113.811348</td>
      <td>22.628067</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>34745</td>
      <td>20:10:06</td>
      <td>113.819885</td>
      <td>22.647800</td>
      <td>0</td>
      <td>54</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>544994</th>
      <td>28265</td>
      <td>21:35:13</td>
      <td>114.321503</td>
      <td>22.709499</td>
      <td>0</td>
      <td>18</td>
    </tr>
    <tr>
      <th>544995</th>
      <td>28265</td>
      <td>09:08:02</td>
      <td>114.322701</td>
      <td>22.681700</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>544996</th>
      <td>28265</td>
      <td>09:14:31</td>
      <td>114.336700</td>
      <td>22.690100</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>544997</th>
      <td>28265</td>
      <td>21:19:12</td>
      <td>114.352600</td>
      <td>22.728399</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>544998</th>
      <td>28265</td>
      <td>19:08:06</td>
      <td>114.137703</td>
      <td>22.621700</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>544999 rows × 6 columns</p>
</div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#读取区域信息</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="n">sz</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;sz/sz.shp&#39;</span><span class="p">)</span>
<span class="n">sz</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">sz</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/output_3_1.png" src="../_images/output_3_1.png" />
<section id="id2">
<h2>Data pre-processing<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>TransBigData integrates several common methods for data pre-processing. Using the <cite>tbd.clean_outofshape</cite> method, given the data and the GeoDataFrame of the study area, it can delete the data outside the study area. The <cite>tbd.clean_taxi_status</cite> method can filters out the data with instantaneous changes in passenger status(OpenStatus). When using the preprocessing method, the corresponding column names need to be passed in as parameters：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#数据预处理</span>
<span class="c1">#剔除研究范围外的数据</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">tbd</span><span class="o">.</span><span class="n">clean_outofshape</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Lng&#39;</span><span class="p">,</span> <span class="s1">&#39;Lat&#39;</span><span class="p">],</span> <span class="n">accuracy</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<span class="c1">#剔除出租车数据中载客状态瞬间变化的记录</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">tbd</span><span class="o">.</span><span class="n">clean_taxi_status</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;VehicleNum&#39;</span><span class="p">,</span> <span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="s1">&#39;OpenStatus&#39;</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="id3">
<h2>Data Gridding<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>The most basic way to express the data distribution is in the form of geograpic grids; after the data gridding, each GPS data point is mapped to the corresponding grid. For data gridding, you need to determine the gridding parameters at first(which can be interpreted as defining a grid coordinate system):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#栅格化</span>
<span class="c1">#定义范围，获取栅格化参数</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="mf">113.6</span><span class="p">,</span><span class="mf">22.4</span><span class="p">,</span><span class="mf">114.8</span><span class="p">,</span><span class="mf">22.9</span><span class="p">]</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">tbd</span><span class="o">.</span><span class="n">grid_params</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span><span class="n">accuracy</span> <span class="o">=</span> <span class="mi">500</span><span class="p">)</span>
<span class="n">params</span>
</pre></div>
</div>
<p>(113.6, 22.4, 0.004872390756896538, 0.004496605206422906)</p>
<p>After obtaining the gridding parameters, the next step is to map the GPS is to their corresponding grids. Using the <cite>tbd.GPS_to_grids</cite>, it will generate the LONCOL column and the LATCOL column. The two columns together can specify a grid:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#将GPS栅格化</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;LONCOL&#39;</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;LATCOL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbd</span><span class="o">.</span><span class="n">GPS_to_grids</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Lng&#39;</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Lat&#39;</span><span class="p">],</span><span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
<p>Count the amount of data in each grids:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#集计栅格数据量</span>
<span class="n">datatest</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;LONCOL&#39;</span><span class="p">,</span><span class="s1">&#39;LATCOL&#39;</span><span class="p">])[</span><span class="s1">&#39;VehicleNum&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</pre></div>
</div>
<p>Generate the geometry of the grids and transform it into a GeoDataFrame:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#生成栅格地理图形</span>
<span class="n">datatest</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbd</span><span class="o">.</span><span class="n">gridid_to_polygon</span><span class="p">(</span><span class="n">datatest</span><span class="p">[</span><span class="s1">&#39;LONCOL&#39;</span><span class="p">],</span><span class="n">datatest</span><span class="p">[</span><span class="s1">&#39;LATCOL&#39;</span><span class="p">],</span><span class="n">params</span><span class="p">)</span>
<span class="c1">#转为GeoDataFrame</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="n">datatest</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">datatest</span><span class="p">)</span>
</pre></div>
</div>
<p>Plot the generated grids:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#绘制</span>
<span class="n">datatest</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span> <span class="o">=</span> <span class="s1">&#39;VehicleNum&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_17_1.png" src="../_images/output_17_1.png" />
</section>
<section id="od">
<h2>Origin-destination(OD) Extraction and aggregate taxi trips<a class="headerlink" href="#od" title="Permalink to this headline">¶</a></h2>
<p>Use the <cite>tbd.taxigps_to_od</cite> method and pass in the corresponding column name to extract the taxi trip OD:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#从GPS数据提取OD</span>
<span class="n">oddata</span> <span class="o">=</span> <span class="n">tbd</span><span class="o">.</span><span class="n">taxigps_to_od</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;VehicleNum&#39;</span><span class="p">,</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span><span class="s1">&#39;Lng&#39;</span><span class="p">,</span><span class="s1">&#39;Lat&#39;</span><span class="p">,</span><span class="s1">&#39;OpenStatus&#39;</span><span class="p">])</span>
<span class="n">oddata</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>VehicleNum</th>
      <th>stime</th>
      <th>slon</th>
      <th>slat</th>
      <th>etime</th>
      <th>elon</th>
      <th>elat</th>
      <th>ID</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>427075</th>
      <td>22396</td>
      <td>00:19:41</td>
      <td>114.013016</td>
      <td>22.664818</td>
      <td>00:23:01</td>
      <td>114.021400</td>
      <td>22.663918</td>
      <td>0</td>
    </tr>
    <tr>
      <th>131301</th>
      <td>22396</td>
      <td>00:41:51</td>
      <td>114.021767</td>
      <td>22.640200</td>
      <td>00:43:44</td>
      <td>114.026070</td>
      <td>22.640266</td>
      <td>1</td>
    </tr>
    <tr>
      <th>417417</th>
      <td>22396</td>
      <td>00:45:44</td>
      <td>114.028099</td>
      <td>22.645082</td>
      <td>00:47:44</td>
      <td>114.030380</td>
      <td>22.650017</td>
      <td>2</td>
    </tr>
    <tr>
      <th>376160</th>
      <td>22396</td>
      <td>01:08:26</td>
      <td>114.034897</td>
      <td>22.616301</td>
      <td>01:16:34</td>
      <td>114.035614</td>
      <td>22.646717</td>
      <td>3</td>
    </tr>
    <tr>
      <th>21768</th>
      <td>22396</td>
      <td>01:26:06</td>
      <td>114.046021</td>
      <td>22.641251</td>
      <td>01:34:48</td>
      <td>114.066048</td>
      <td>22.636183</td>
      <td>4</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>57666</th>
      <td>36805</td>
      <td>22:37:42</td>
      <td>114.113403</td>
      <td>22.534767</td>
      <td>22:48:01</td>
      <td>114.114365</td>
      <td>22.550632</td>
      <td>5332</td>
    </tr>
    <tr>
      <th>175519</th>
      <td>36805</td>
      <td>22:49:12</td>
      <td>114.114365</td>
      <td>22.550632</td>
      <td>22:50:40</td>
      <td>114.115501</td>
      <td>22.557983</td>
      <td>5333</td>
    </tr>
    <tr>
      <th>212092</th>
      <td>36805</td>
      <td>22:52:07</td>
      <td>114.115402</td>
      <td>22.558083</td>
      <td>23:03:27</td>
      <td>114.118484</td>
      <td>22.547867</td>
      <td>5334</td>
    </tr>
    <tr>
      <th>119041</th>
      <td>36805</td>
      <td>23:03:45</td>
      <td>114.118484</td>
      <td>22.547867</td>
      <td>23:20:09</td>
      <td>114.133286</td>
      <td>22.617750</td>
      <td>5335</td>
    </tr>
    <tr>
      <th>224103</th>
      <td>36805</td>
      <td>23:36:19</td>
      <td>114.112968</td>
      <td>22.549601</td>
      <td>23:43:12</td>
      <td>114.089485</td>
      <td>22.538918</td>
      <td>5336</td>
    </tr>
  </tbody>
</table>
<p>5337 rows × 8 columns</p>
</div><p>Aggregate the extracted OD and generate LineString GeoDataFrame</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#栅格化OD并集计</span>
<span class="n">od_gdf</span> <span class="o">=</span> <span class="n">tbd</span><span class="o">.</span><span class="n">odagg_grid</span><span class="p">(</span><span class="n">oddata</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>
<span class="n">od_gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span> <span class="o">=</span> <span class="s1">&#39;count&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_22_11.png" src="../_images/output_22_11.png" />
</section>
<section id="id4">
<h2>Aggregate OD into polygons<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p><cite>TransBigData</cite> also provides the method for aggregating OD into polygons</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#OD集计到小区（在不传入栅格化参数时，直接用经纬度匹配）</span>
<span class="n">od_gdf</span> <span class="o">=</span> <span class="n">tbd</span><span class="o">.</span><span class="n">odagg_shape</span><span class="p">(</span><span class="n">oddata</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">round_accuracy</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">od_gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span> <span class="o">=</span> <span class="s1">&#39;count&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_25_1.png" src="../_images/output_25_1.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#OD集计到小区（传入栅格化参数时，先栅格化后匹配，可加快匹配速度，数据量大时建议使用）</span>
<span class="n">od_gdf</span> <span class="o">=</span> <span class="n">tbd</span><span class="o">.</span><span class="n">odagg_shape</span><span class="p">(</span><span class="n">oddata</span><span class="p">,</span><span class="n">sz</span><span class="p">,</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">)</span>
<span class="n">od_gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span> <span class="o">=</span> <span class="s1">&#39;count&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/output_26_1.png" src="../_images/output_26_1.png" />
</section>
<section id="matplotlib">
<h2>Matplotlib-based map drawing<a class="headerlink" href="#matplotlib" title="Permalink to this headline">¶</a></h2>
<p>TransBigData also provide basemap loading in matplotlib. Before using this method, you need to set your mapboxtoken and the storage location for the basemap, see: <a class="reference external" href="https://transbigdata.readthedocs.io/en/latest/plot_map.html">this link</a>。<cite>tbd.plot_map</cite> to add basemap and <cite>tbd.plotscale</cite> to add scale and compass:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#创建图框</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">plot_map</span>
<span class="n">fig</span> <span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">,(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="n">dpi</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="c1">#添加地图底图</span>
<span class="n">tbd</span><span class="o">.</span><span class="n">plot_map</span><span class="p">(</span><span class="n">plt</span><span class="p">,</span><span class="n">bounds</span><span class="p">,</span><span class="n">zoom</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span><span class="n">style</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
<span class="c1">#绘制colorbar</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.33</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="c1">#绘制OD</span>
<span class="n">od_gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span><span class="n">vmax</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span><span class="n">column</span> <span class="o">=</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span><span class="n">cax</span> <span class="o">=</span> <span class="n">cax</span><span class="p">,</span><span class="n">legend</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="c1">#绘制小区底图</span>
<span class="n">sz</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span><span class="n">edgecolor</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">facecolor</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.2</span><span class="p">),</span><span class="n">linewidths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="c1">#添加比例尺和指北针</span>
<span class="n">tbd</span><span class="o">.</span><span class="n">plotscale</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">,</span><span class="n">textsize</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span><span class="n">compasssize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">accuracy</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span><span class="n">rect</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.06</span><span class="p">,</span><span class="mf">0.03</span><span class="p">],</span><span class="n">zorder</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/output_29_01.png" src="../_images/output_29_01.png" />
</section>
<section id="id5">
<h2>Extraction of taxi trajectpries<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>Using <cite>tbd.taxigps_traj_point</cite> method, inputing GPS data and OD data, trajectory points can be extracted</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data_deliver</span><span class="p">,</span><span class="n">data_idle</span> <span class="o">=</span> <span class="n">tbd</span><span class="o">.</span><span class="n">taxigps_traj_point</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">oddata</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;VehicleNum&#39;</span><span class="p">,</span> <span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="s1">&#39;Lng&#39;</span><span class="p">,</span> <span class="s1">&#39;Lat&#39;</span><span class="p">,</span> <span class="s1">&#39;OpenStatus&#39;</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data_deliver</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>VehicleNum</th>
      <th>Time</th>
      <th>Lng</th>
      <th>Lat</th>
      <th>OpenStatus</th>
      <th>Speed</th>
      <th>LONCOL</th>
      <th>LATCOL</th>
      <th>ID</th>
      <th>flag</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>427075</th>
      <td>22396</td>
      <td>00:19:41</td>
      <td>114.013016</td>
      <td>22.664818</td>
      <td>1</td>
      <td>63.0</td>
      <td>85.0</td>
      <td>59.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>427085</th>
      <td>22396</td>
      <td>00:19:49</td>
      <td>114.014030</td>
      <td>22.665483</td>
      <td>1</td>
      <td>55.0</td>
      <td>85.0</td>
      <td>59.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>416622</th>
      <td>22396</td>
      <td>00:21:01</td>
      <td>114.018898</td>
      <td>22.662500</td>
      <td>1</td>
      <td>1.0</td>
      <td>86.0</td>
      <td>58.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>427480</th>
      <td>22396</td>
      <td>00:21:41</td>
      <td>114.019348</td>
      <td>22.662300</td>
      <td>1</td>
      <td>7.0</td>
      <td>86.0</td>
      <td>58.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>416623</th>
      <td>22396</td>
      <td>00:22:21</td>
      <td>114.020615</td>
      <td>22.663366</td>
      <td>1</td>
      <td>0.0</td>
      <td>86.0</td>
      <td>59.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>170960</th>
      <td>36805</td>
      <td>23:42:31</td>
      <td>114.092766</td>
      <td>22.538317</td>
      <td>1</td>
      <td>66.0</td>
      <td>101.0</td>
      <td>31.0</td>
      <td>5336.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>170958</th>
      <td>36805</td>
      <td>23:42:37</td>
      <td>114.091721</td>
      <td>22.538349</td>
      <td>1</td>
      <td>65.0</td>
      <td>101.0</td>
      <td>31.0</td>
      <td>5336.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>170974</th>
      <td>36805</td>
      <td>23:42:43</td>
      <td>114.090752</td>
      <td>22.538300</td>
      <td>1</td>
      <td>60.0</td>
      <td>101.0</td>
      <td>31.0</td>
      <td>5336.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>170973</th>
      <td>36805</td>
      <td>23:42:49</td>
      <td>114.089813</td>
      <td>22.538099</td>
      <td>1</td>
      <td>62.0</td>
      <td>101.0</td>
      <td>31.0</td>
      <td>5336.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>253064</th>
      <td>36805</td>
      <td>23:42:55</td>
      <td>114.089500</td>
      <td>22.538067</td>
      <td>1</td>
      <td>51.0</td>
      <td>100.0</td>
      <td>31.0</td>
      <td>5336.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
<p>190492 rows × 10 columns</p>
</div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data_idle</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>VehicleNum</th>
      <th>Time</th>
      <th>Lng</th>
      <th>Lat</th>
      <th>OpenStatus</th>
      <th>Speed</th>
      <th>LONCOL</th>
      <th>LATCOL</th>
      <th>ID</th>
      <th>flag</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>416628</th>
      <td>22396</td>
      <td>00:23:01</td>
      <td>114.021400</td>
      <td>22.663918</td>
      <td>0</td>
      <td>25.0</td>
      <td>86.0</td>
      <td>59.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>401744</th>
      <td>22396</td>
      <td>00:25:01</td>
      <td>114.027115</td>
      <td>22.662100</td>
      <td>0</td>
      <td>25.0</td>
      <td>88.0</td>
      <td>58.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>394630</th>
      <td>22396</td>
      <td>00:25:41</td>
      <td>114.024551</td>
      <td>22.659834</td>
      <td>0</td>
      <td>21.0</td>
      <td>87.0</td>
      <td>58.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>394671</th>
      <td>22396</td>
      <td>00:26:21</td>
      <td>114.022797</td>
      <td>22.658367</td>
      <td>0</td>
      <td>0.0</td>
      <td>87.0</td>
      <td>57.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>394672</th>
      <td>22396</td>
      <td>00:26:29</td>
      <td>114.022797</td>
      <td>22.658367</td>
      <td>0</td>
      <td>0.0</td>
      <td>87.0</td>
      <td>57.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>64411</th>
      <td>36805</td>
      <td>23:53:09</td>
      <td>114.120354</td>
      <td>22.544300</td>
      <td>1</td>
      <td>2.0</td>
      <td>107.0</td>
      <td>32.0</td>
      <td>5336.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>64405</th>
      <td>36805</td>
      <td>23:53:15</td>
      <td>114.120354</td>
      <td>22.544300</td>
      <td>1</td>
      <td>1.0</td>
      <td>107.0</td>
      <td>32.0</td>
      <td>5336.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>64390</th>
      <td>36805</td>
      <td>23:53:21</td>
      <td>114.120354</td>
      <td>22.544300</td>
      <td>1</td>
      <td>0.0</td>
      <td>107.0</td>
      <td>32.0</td>
      <td>5336.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>64406</th>
      <td>36805</td>
      <td>23:53:27</td>
      <td>114.120354</td>
      <td>22.544300</td>
      <td>1</td>
      <td>0.0</td>
      <td>107.0</td>
      <td>32.0</td>
      <td>5336.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>64393</th>
      <td>36805</td>
      <td>23:53:33</td>
      <td>114.120354</td>
      <td>22.544300</td>
      <td>1</td>
      <td>0.0</td>
      <td>107.0</td>
      <td>32.0</td>
      <td>5336.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>312779 rows × 10 columns</p>
</div><p>Generate delivery and idle trajectories from trajectory points</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">traj_deliver</span> <span class="o">=</span> <span class="n">tbd</span><span class="o">.</span><span class="n">points_to_traj</span><span class="p">(</span><span class="n">data_deliver</span><span class="p">)</span>
<span class="n">traj_deliver</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/output_36_1.png" src="../_images/output_36_1.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">traj_idle</span> <span class="o">=</span> <span class="n">tbd</span><span class="o">.</span><span class="n">points_to_traj</span><span class="p">(</span><span class="n">data_idle</span><span class="p">)</span>
<span class="n">traj_idle</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/output_37_1.png" src="../_images/output_37_1.png" />
</section>
<section id="id6">
<h2>Trajectories visualization<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<div class="line-block">
<div class="line">Built-in visualization capabilities of <cite>TransBigData</cite> leverage the visualization package <cite>keplergl</cite> to interactively visualize data on Jupyter notebook with simple code.</div>
<div class="line">To use this method, please install the keplergl package for python</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">keplergl</span>
</pre></div>
</div>
<p>Visualization of trajectory data:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tbd</span><span class="o">.</span><span class="n">visualization_trip</span><span class="p">(</span><span class="n">data_deliver</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/kepler-traj.png" src="../_images/kepler-traj.png" />
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../getting_started.html" class="btn btn-neutral float-left" title="Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../example-busgps/example-busgps.html" class="btn btn-neutral float-right" title="Identifying arrival and departure information from Bus GPS data" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Qing Yu.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>